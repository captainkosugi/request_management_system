# Тестовое задание: Управление заявками

## Задачи:
1. Спроектировать модель данных.
2. Разработать SQL-скрипты для создания таблиц и наполнения их тестовыми данными.
3. Обработать реестр платежей из CSV-файла.
4. Написать аналитические SQL-запросы.
5. Предоставить описание процессов.


## Модель данных

Модель данных включает следующие сущности:

1. **`person`**:
   - Хранит информацию о физических лицах.
   - Поля: `id`, `name`, `experience`, `has_privileges`, `status`.

2. **`service`**:
   - Хранит информацию об услугах.
   - Поля: `id`, `name`, `description`, `is_available`.

3. **`requests`**:
   - Хранит информацию о заявках.
   - Поля: `id`, `person_id`, `service_id`, `status`, `created_at`, `approved_at`.

4. **`payments`**:
   - Хранит информацию о платежах.
   - Поля: `id`, `request_id`, `amount`, `payment_date`, `purpose`.
  

## Связи между таблицами:
- `requests.person_id` → `person.id`
- `requests.service_id` → `service.id`
- `payments.request_id` → `requests.id`

## Как использовать

### 1. Создайте базу данных
```sql
CREATE DATABASE db_name;
```
### 2. Загрузите структуру таблиц
```bash
psql -U postgres -d db_name -f schema.sql
```
### 3. Добавьте тестовые данные
```bash
psql -U postgres -d db_name -f test_data.sql
```
### 4. Загрузите данные из CSV
```bash
psql -U postgres -d db_name -f load_payments.sql
```
### 5. Выполните аналитические запросы
```bash
psql -U postgres -d db_name -f queries.sql
```

## Описание процессов
1. Когда ФЛ регистрируется в системе, он предоставляет информацию о себе: ФИО, стаж, наличие привилегий и текущий статус. Эти данные используются для определения доступности услуг. Если ФЛ уже зарегистрирован, его профиль обновляется при изменении параметров, таких как стаж или статус.
2. ФЛ выбирает услугу из доступного списка. Система проверяет, соответствует ли он требованиям для получения выбранной услуги. Например, некоторые услуги могут быть доступны только клиентам с определённым стажем или привилегиями. Также система учитывает, что каждая услуга может быть оказана только один раз в год. Если все условия выполнены, создаётся заявка на оказание услуги.
3. Если заявка одобрена, ФЛ получает уведомление с информацией о дальнейших шагах, включая сроки и сумму предоплаты. Если заявка отклоняется, клиент также уведомляется о решении. Одобренная заявка помечается как "одобрена", и начинается процесс оплаты.
4. ФЛ вносит предоплату за услугу. Платёж поступает в виде реестра платежей в формате CSV. Система автоматически обрабатывает этот файл, извлекая номер заявки из поля "Назначение платежа". Если номер заявки указан корректно, платёж привязывается к соответствующей заявке. В случае ошибок в данных (например, отсутствие номера заявки или некорректный формат), платёж остаётся без привязки, и администратору отправляется уведомление для ручной проверки.
5. После внесения предоплаты услуга оказывается клиенту. После завершения оказания услуги клиент уведомляется о необходимости внести окончательную оплату. Процесс обработки окончательной оплаты аналогичен процессу предоплаты: платёж поступает в виде CSV-файла, система проверяет его корректность и привязывает к заявке. Если сумма всех платежей по заявке равна стоимости услуги, заявка считается полностью оплаченной.
